<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:CompanyDashboard.ViewModels"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="600"
             x:Class="CompanyDashboard.Views.TeamView"
             x:DataType="vm:TeamViewModel">
    
    <Border Background="{StaticResource DashboardBgBrush}" Padding="{StaticResource PageMargin}">
        <Grid RowDefinitions="Auto,*">
            <!-- Header -->
            <StackPanel Grid.Row="0" Margin="0,0,0,20">
                <TextBlock Text="Team Management" Classes="Header" FontSize="26"/>
                <TextBlock Text="Manage your staff, roles, and access permissions." Foreground="{StaticResource DarkTextBrush}"/>
            </StackPanel>

            <TabControl Grid.Row="1">
                <!-- Tab: Staff Members -->
                <TabItem Header="Staff Members" Foreground="Black"  FontSize="16" FontWeight="SemiBold">
                    <Grid ColumnDefinitions="*,350" Margin="0,20,0,0">
                        <!-- Users List -->
                        <Border Grid.Column="0" Classes="Card" Margin="0,0,20,0">
                            <Grid RowDefinitions="Auto,Auto,*">
                                <Grid Grid.Row="0" Margin="0,0,0,15">
                                    <TextBlock Text="All Users" FontSize="18" FontWeight="Bold" Foreground="{StaticResource DarkTextBrush}"/>
                                    <Button Classes="Outline" Content="ðŸ”„ Refresh" Command="{Binding RefreshCommand}" HorizontalAlignment="Right"/>
                                </Grid>

                                <!-- Table Header -->
                                <Grid Grid.Row="1" ColumnDefinitions="*,*,*,100" Margin="15,0,15,5">
                                    <TextBlock Grid.Column="0" Text="NAME" FontWeight="SemiBold" Foreground="{StaticResource LightTextBrush}" FontSize="12"/>
                                    <TextBlock Grid.Column="1" Text="EMAIL" FontWeight="SemiBold" Foreground="{StaticResource LightTextBrush}" FontSize="12"/>
                                    <TextBlock Grid.Column="2" Text="ROLE" FontWeight="SemiBold" Foreground="{StaticResource LightTextBrush}" FontSize="12"/>
                                    <TextBlock Grid.Column="3" Text="STATUS" FontWeight="SemiBold" Foreground="{StaticResource LightTextBrush}" FontSize="12"/>
                                </Grid>
                                <Separator Grid.Row="1" VerticalAlignment="Bottom" Background="{StaticResource BorderBrush}" Margin="0,5"/>

                                <ListBox Grid.Row="2" ItemsSource="{Binding Users}" Background="Transparent" BorderThickness="0">
                                    <ListBox.ItemTemplate>
                                        <DataTemplate>
                                            <Border BorderBrush="{StaticResource BorderBrush}" BorderThickness="0,0,0,1" Padding="10">
                                                <Grid ColumnDefinitions="*,*,*,100">
                                                    <TextBlock Grid.Column="0" Text="{Binding FullName}" VerticalAlignment="Center" FontWeight="SemiBold" Foreground="{StaticResource DarkTextBrush}"/>
                                                    <TextBlock Grid.Column="1" Text="{Binding Email}" VerticalAlignment="Center" Foreground="{StaticResource LightTextBrush}"/>
                                                    <!-- Display Roles list as comma separated string? Or just first role for MVP -->
                                                    <!-- Ideally update backend to return single role name or join them. CompanyUser has Role (string) property usually? 
                                                         Checking CompanyModels.cs: line 294 public string? Role. BUT line 297 implies it might be list.
                                                         Let's assume just one for now or bind to Role property from user model. -->
                                                    <TextBlock Grid.Column="2" Text="{Binding Role}" VerticalAlignment="Center" Foreground="{StaticResource PrimaryBlueBrush}"/>
                                                    
                                                    <Border Grid.Column="3" Background="#E8F5E9" CornerRadius="12" Padding="8,4" HorizontalAlignment="Left" VerticalAlignment="Center">
                                                        <TextBlock Text="Active" FontSize="11" Foreground="#2E7D32" FontWeight="Bold"/>
                                                    </Border>
                                                </Grid>
                                            </Border>
                                        </DataTemplate>
                                    </ListBox.ItemTemplate>
                                </ListBox>
                            </Grid>
                        </Border>

                        <!-- Add User Form -->
                        <Border Grid.Column="1" Classes="Card">
                            <StackPanel Spacing="15">
                                <StackPanel Orientation="Horizontal" Spacing="10">
                                    <TextBlock Text="Add New Member" FontSize="18" FontWeight="Bold" Foreground="{StaticResource DarkTextBrush}"/>
                                </StackPanel>
                                <TextBlock Text="Invite a new member to join your company dashboard." Foreground="{StaticResource LightTextBrush}" TextWrapping="Wrap" FontSize="13"/>
                                
                                <ScrollViewer MaxHeight="600">
                                    <StackPanel Spacing="15">
                                        <StackPanel Spacing="5">
                                            <TextBlock Text="Full Name" FontWeight="SemiBold" Foreground="{StaticResource DarkTextBrush}"/>
                                            <TextBox Text="{Binding NewUserFullName}" Watermark="John Doe"/>
                                        </StackPanel>
                                        
                                        <StackPanel Spacing="5">
                                            <TextBlock Text="Personal Email (OTP Destination)" FontWeight="SemiBold" Foreground="{StaticResource DarkTextBrush}"/>
                                            <TextBox Text="{Binding NewUserEmail}" Watermark="john.doe@gmail.com"/>
                                        </StackPanel>
                                        
                                        <StackPanel Spacing="5">
                                            <TextBlock Text="Company Login Email (Username)" FontWeight="SemiBold" Foreground="{StaticResource DarkTextBrush}"/>
                                            <TextBox Text="{Binding NewUserLoginEmail}" Watermark="john@company.com"/>
                                        </StackPanel>
                                        
                                        <StackPanel Spacing="5">
                                            <TextBlock Text="Role" FontWeight="SemiBold" Foreground="{StaticResource DarkTextBrush}"/>
                                            <ComboBox ItemsSource="{Binding Roles}" SelectedItem="{Binding SelectedRoleForNewUser}" HorizontalAlignment="Stretch" PlaceholderText="Select a Role">
                                                <ComboBox.ItemTemplate>
                                                    <DataTemplate>
                                                        <TextBlock Text="{Binding Name}"/>
                                                    </DataTemplate>
                                                </ComboBox.ItemTemplate>
                                            </ComboBox>
                                        </StackPanel>

                                        <StackPanel Spacing="5">
                                            <TextBlock Text="Temporary Password" FontWeight="SemiBold" Foreground="{StaticResource DarkTextBrush}"/>
                                            <TextBox Text="{Binding NewUserPassword}" PasswordChar="â—"/>
                                        </StackPanel>
                                        
                                        <Button Content="Create User" Command="{Binding CreateUserCommand}" HorizontalAlignment="Stretch" Margin="0,10,0,0"/>

                                        <TextBlock Text="{Binding ErrorMessage}" Foreground="Red" TextWrapping="Wrap" IsVisible="{Binding ErrorMessage, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>
                                    </StackPanel>
                                </ScrollViewer>
                            </StackPanel>
                        </Border>
                    </Grid>
                </TabItem>

                <!-- Tab: Roles & Permissions -->
                <TabItem Header="Roles &amp; Access" Foreground="Black" FontSize="16" FontWeight="SemiBold">
                     <Grid ColumnDefinitions="*,350" Margin="0,20,0,0">
                        <!-- Roles List -->
                        <Border Grid.Column="0" Classes="Card" Margin="0,0,20,0">
                            <Grid RowDefinitions="Auto,Auto,*,Auto">
                                <Grid Grid.Row="0" Margin="0,0,0,15">
                                    <TextBlock Text="Defined Roles" FontSize="18" FontWeight="Bold" Foreground="{StaticResource DarkTextBrush}"/>
                                </Grid>

                                <!-- Header -->
                                <Grid Grid.Row="1" ColumnDefinitions="*,100" Margin="15,0,15,5">
                                    <TextBlock Grid.Column="0" Text="ROLE NAME" FontWeight="SemiBold" Foreground="{StaticResource LightTextBrush}" FontSize="12"/>
                                    <TextBlock Grid.Column="1" Text="ACTIONS" FontWeight="SemiBold" Foreground="{StaticResource LightTextBrush}" FontSize="12" HorizontalAlignment="Right"/>
                                </Grid>
                                <Separator Grid.Row="1" VerticalAlignment="Bottom" Background="{StaticResource BorderBrush}" Margin="0,5"/>

                                <ListBox Grid.Row="2" ItemsSource="{Binding Roles}" SelectedItem="{Binding SelectedRole}" Background="Transparent" BorderThickness="0">
                                    <ListBox.ItemTemplate>
                                        <DataTemplate>
                                            <Border BorderBrush="{StaticResource BorderBrush}" BorderThickness="0,0,0,1" Padding="15">
                                                <Grid ColumnDefinitions="*,100">
                                                    <StackPanel Grid.Column="0">
                                                        <TextBlock Text="{Binding Name}" FontWeight="Bold" FontSize="15" Foreground="{StaticResource DarkTextBrush}"/>
                                                        <TextBlock Text="{Binding Permissions.Count, StringFormat='{}{0} Permissions Assigned'}" FontSize="12" Foreground="{StaticResource LightTextBrush}"/>
                                                    </StackPanel>
                                                    
                                                    <Button Grid.Column="1" Classes="Ghost" Content="ðŸ—‘ï¸" Padding="8" Command="{Binding $parent[UserControl].DataContext.DeleteRoleCommand}" CommandParameter="{Binding}" Foreground="Red" HorizontalAlignment="Right"/>
                                                </Grid>
                                            </Border>
                                        </DataTemplate>
                                    </ListBox.ItemTemplate>
                                </ListBox>
                            </Grid>
                        </Border>

                        <!-- Selected Role Details -->
                        <Border Grid.Column="1" Classes="Card">
                            <Grid>
                                <!-- EDIT MODE: Role Selected -->
                                <StackPanel Spacing="15" IsVisible="{Binding SelectedRole, Converter={x:Static ObjectConverters.IsNotNull}}">
                                    <Grid ColumnDefinitions="*,Auto">
                                        <TextBlock Text="Role Permissions" FontSize="18" FontWeight="Bold" Foreground="{StaticResource DarkTextBrush}" VerticalAlignment="Center"/>
                                        <Button Grid.Column="1" Classes="Outline" Content="New Role" Command="{Binding CreateNewRoleModeCommand}" FontSize="12" Padding="10,5"/>
                                    </Grid>
                                    
                                    <StackPanel Orientation="Horizontal" Spacing="5">
                                        <TextBlock Text="Editing:" Foreground="{StaticResource LightTextBrush}"/>
                                        <TextBlock Text="{Binding SelectedRole.Name}" FontWeight="Bold" Foreground="{StaticResource PrimaryBlueBrush}"/>
                                    </StackPanel>
                                    
                                    <Separator Background="{StaticResource BorderBrush}"/>
                                    
                                    <TextBlock Text="Current Permissions:" FontWeight="SemiBold" Foreground="{StaticResource DarkTextBrush}"/>
                                    <ScrollViewer MaxHeight="300">
                                        <ItemsControl ItemsSource="{Binding SelectedRole.Permissions}">
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <Border Background="#F8F9FA" Padding="10,5" Margin="0,0,0,5" CornerRadius="4">
                                                        <TextBlock Text="{Binding Name}" Foreground="{StaticResource DarkTextBrush}"/>
                                                    </Border>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </ScrollViewer>

                                    <Separator Background="{StaticResource BorderBrush}"/>

                                    <TextBlock Text="Add Permission" FontWeight="SemiBold" Foreground="{StaticResource DarkTextBrush}"/>
                                    <Grid ColumnDefinitions="*,Auto">
                                        <ComboBox Grid.Column="0" ItemsSource="{Binding AvailablePermissions}" SelectedItem="{Binding SelectedPermissionToAdd}" HorizontalAlignment="Stretch" PlaceholderText="Select Permission">
                                            <ComboBox.ItemTemplate>
                                                <DataTemplate>
                                                    <TextBlock Text="{Binding Name}"/>
                                                </DataTemplate>
                                            </ComboBox.ItemTemplate>
                                        </ComboBox>
                                        <Button Grid.Column="1" Classes="Outline" Content="+" Margin="5,0,0,0" Command="{Binding AssignPermissionCommand}"/>
                                    </Grid>
                                </StackPanel>
                                
                                <!-- CREATE MODE: No Role Selected -->
                                <StackPanel Spacing="15" IsVisible="{Binding SelectedRole, Converter={x:Static ObjectConverters.IsNull}}">
                                    <TextBlock Text="Create New Role" FontSize="18" FontWeight="Bold" Foreground="{StaticResource DarkTextBrush}"/>
                                    <TextBlock Text="Define a new role to assign to your staff members." Foreground="{StaticResource LightTextBrush}" TextWrapping="Wrap" FontSize="13"/>
                                    
                                    <StackPanel Spacing="15" Margin="0,10,0,0">
                                        <StackPanel Spacing="5">
                                            <TextBlock Text="Role Name" FontWeight="SemiBold" Foreground="{StaticResource DarkTextBrush}"/>
                                            <TextBox Text="{Binding NewRoleName}" Watermark="e.g. Bus Driver, Ticket Seller"/>
                                        </StackPanel>
                                        
                                        <Button Content="Create Role" Command="{Binding CreateRoleCommand}" HorizontalAlignment="Stretch" Margin="0,10,0,0"/>

                                        <TextBlock Text="{Binding ErrorMessage}" Foreground="Red" TextWrapping="Wrap" IsVisible="{Binding ErrorMessage, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>
                                    </StackPanel>
                                </StackPanel>
                            </Grid>
                        </Border>
                    </Grid>
                </TabItem>
            </TabControl>
        </Grid>
    </Border>
</UserControl>
