<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:CompanyDashboard.ViewModels"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="450"
             x:Class="CompanyDashboard.Views.TicketsView"
             x:DataType="vm:TicketsViewModel">

    <ScrollViewer Padding="{StaticResource PageMargin}">
        <StackPanel Spacing="20">
            <Grid>
                <TextBlock Classes="Header" Text="Ticket Management"/>
                <Button Classes="Outline" Content="ðŸ”„ Refresh" Command="{Binding RefreshCommand}" HorizontalAlignment="Right"/>
            </Grid>

            <!-- QR Code Verification Card -->
            <Border Classes="Card">
                <StackPanel Spacing="15">
                    <TextBlock Text="Verify QR Code" FontSize="18" FontWeight="Bold" Foreground="{StaticResource DarkTextBrush}"/>
                    <Grid ColumnDefinitions="*,Auto">
                        <TextBox Grid.Column="0" Text="{Binding QrCodeInput}" Watermark="Enter QR code token" Margin="0,0,10,0"/>
                        <Button Grid.Column="1" Content="Verify" Command="{Binding VerifyQrCodeCommand}"/>
                    </Grid>
                    
                    <!-- Result Display -->
                    <Border Background="#E8F5E9" BorderBrush="#C8E6C9" BorderThickness="1" CornerRadius="4" Padding="10" IsVisible="{Binding !!VerificationResult}">
                        <TextBlock Text="{Binding VerificationResult}" Foreground="#2E7D32" FontWeight="SemiBold" TextWrapping="Wrap"/>
                    </Border>
                    
                    <Border Background="#FFEBEE" BorderBrush="#FFCDD2" BorderThickness="1" CornerRadius="4" Padding="10" IsVisible="{Binding !!ErrorMessage}">
                         <TextBlock Text="{Binding ErrorMessage}" Foreground="#C62828" TextWrapping="Wrap"/>
                    </Border>
                </StackPanel>
            </Border>

            <!-- Tickets List Card -->
            <Border Classes="Card">
                <StackPanel Spacing="15">
                     <Grid>
                        <TextBlock Text="Ticket Transactions" FontSize="18" FontWeight="Bold" Foreground="{StaticResource DarkTextBrush}"/>
                        <Button Classes="Ghost" Content="Export CSV" HorizontalAlignment="Right"/>
                     </Grid>
                    
                    <!-- Table Header -->
                     <Grid ColumnDefinitions="150,*,100,150,150" Margin="15,0,15,5">
                        <TextBlock Grid.Column="0" Text="TICKET ID" FontWeight="SemiBold" Foreground="{StaticResource LightTextBrush}" FontSize="12"/>
                        <TextBlock Grid.Column="1" Text="PASSENGER" FontWeight="SemiBold" Foreground="{StaticResource LightTextBrush}" FontSize="12"/>
                        <TextBlock Grid.Column="2" Text="STATUS" FontWeight="SemiBold" Foreground="{StaticResource LightTextBrush}" FontSize="12"/>
                        <TextBlock Grid.Column="3" Text="PURCHASED" FontWeight="SemiBold" Foreground="{StaticResource LightTextBrush}" FontSize="12"/>
                        <TextBlock Grid.Column="4" Text="ACTIONS" FontWeight="SemiBold" Foreground="{StaticResource LightTextBrush}" FontSize="12" HorizontalAlignment="Right"/>
                    </Grid>
                    <Separator Background="{StaticResource BorderBrush}" Margin="0,-5,0,5"/>

                    <ListBox ItemsSource="{Binding Tickets}" SelectedItem="{Binding SelectedTicket}" Background="Transparent" BorderThickness="0">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <Border BorderBrush="{StaticResource BorderBrush}" BorderThickness="0,0,0,1" Padding="10">
                                    <Grid ColumnDefinitions="150,*,100,150,150">
                                        <TextBlock Grid.Column="0" Text="{Binding Id}" VerticalAlignment="Center" FontSize="12" Foreground="{StaticResource LightTextBrush}"/>
                                        <TextBlock Grid.Column="1" Text="{Binding FullName}" VerticalAlignment="Center" FontWeight="SemiBold" Foreground="{StaticResource DarkTextBrush}"/>
                                        
                                        <!-- Status Badge -->
                                        <StackPanel Grid.Column="2" VerticalAlignment="Center">
                                            <Border Background="#E3F2FD" CornerRadius="4" Padding="8,2" HorizontalAlignment="Left" IsVisible="{Binding Status, Converter={StaticResource StringEqualsConverter}, ConverterParameter='Active'}">
                                                <TextBlock Text="{Binding Status}" FontSize="11" Foreground="{StaticResource PrimaryBlueBrush}" FontWeight="Bold"/>
                                            </Border>
                                             <!-- Fallback for other statuses if needed, or simple text -->
                                             <TextBlock Text="{Binding Status}" FontSize="11" Foreground="{StaticResource DarkTextBrush}" IsVisible="{Binding Status, Converter={StaticResource StringNotEqualsConverter}, ConverterParameter='Active'}"/>
                                        </StackPanel>

                                        <TextBlock Grid.Column="3" Text="{Binding CreatedAt, StringFormat='{}{0:g}'}" VerticalAlignment="Center" Foreground="{StaticResource LightTextBrush}"/>
                                        
                                        <StackPanel Grid.Column="4" Orientation="Horizontal" Spacing="5" HorizontalAlignment="Right">
                                            <Button Classes="Outline" Content="âœ…" Padding="8,4" Click="OnMarkPaid" ToolTip.Tip="Mark Paid"/>
                                            <Button Classes="Outline" Content="âŒ" Padding="8,4" Click="OnMarkCancelled" ToolTip.Tip="Cancel"/>
                                            <Button Classes="Ghost" Content="ðŸ—‘ï¸" Padding="8" Click="OnDelete" Foreground="Red" ToolTip.Tip="Delete"/>
                                        </StackPanel>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                </StackPanel>
            </Border>
        </StackPanel>
    </ScrollViewer>
</UserControl>

