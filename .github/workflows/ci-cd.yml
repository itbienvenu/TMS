name: Monorepo Microservice CI/CD

on:
  push:
    branches: [ "main", "develop" ]
    paths:
      - 'gateway/**'
      - 'services/**'
      - '.github/workflows/ci-cd.yml'

env:
  REGISTRY: ghcr.io # Using GitHub Container Registry (GHCR)

jobs:
  build_and_push:
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        service_name:
          - gateway
          - auth-service
          - user-service
          - company-service
          - ticketing-service
          - qr-service
          - payment-service
        
        dockerfile_path:
          - gateway/Dockerfile
          - services/auth-service/Dockerfile
          - services/user-service/Dockerfile
          - services/company-service/Dockerfile
          - services/ticketing-service/Dockerfile
          - services/qr-service/Dockerfile
          - services/payment-service/Dockerfile
        
        image_tag:
          - ticketing-gateway
          - ticketing-auth-service
          - ticketing-user-service
          - ticketing-company-service
          - ticketing-ticketing-service
          - ticketing-qr-service
          - ticketing-payment-service
          
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Build and Push Docker Image for ${{ matrix.service_name }}
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ matrix.dockerfile_path }}
          push: true
          tags: ${{ env.REGISTRY }}/${{ github.repository }}/${{ matrix.image_tag }}:${{ github.sha }},
                ${{ env.REGISTRY }}/${{ github.repository }}/${{ matrix.image_tag }}:latest


  deploy_via_ssh:
    runs-on: ubuntu-latest
    needs: build_and_push # Only run if ALL service builds succeeded
    environment: staging 
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        
      - name: Install SSH Key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          known_hosts: 'placeholder-to-avoid-warning' 
          
      - name: Run Deployment on EC2 Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 3.12.248.83
          username: ubuntu 
          key: ${{ secrets.SSH_PRIVATE_KEY }} 
          script: |
            # Navigate to the directory containing your docker-compose.yml
            echo "Navigating to project directory..."
            cd /home/ubuntu/ticketing-system 
            
            # Pull the latest code changes (ensures your docker-compose file is up to date)
            echo "Pulling latest code..."
            git pull origin ${{ github.ref_name }} # e.g., 'main' or 'develop'
            
            # Log into GitHub Container Registry (GHCR) on the remote EC2 server
            # This allows the server to pull the new images you just pushed
            echo "Logging into GHCR..."
            echo ${{ secrets.PAT_GHCR }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            # Pull new images and restart services
            echo "Pulling latest Docker images and restarting services..."
            # 1. docker compose pull: Pulls only the images that have changed
            # 2. docker compose up -d: Recreates containers using the newly pulled images
            docker compose pull
            docker compose up -d --force-recreate
            
            echo "Deployment to EC2 complete."
