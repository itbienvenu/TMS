name: Monorepo Microservice CI/CD

on:
  push:
    branches: [ "main" ]
    paths:
      - 'gateway/**'
      - 'services/**'
      - '.github/workflows/ci-cd.yml'

permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io
  DRY_RUN: false # Set to true locally if you don't want to push images
  IMAGE_REPO: ikobeproject/ticketing-system

jobs:
  build_and_push:
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        service:
          - name: gateway
            dockerfile: gateway/Dockerfile
            image_tag: ticketing-gateway
          - name: auth-service
            dockerfile: services/auth-service/Dockerfile
            image_tag: ticketing-auth-service
          - name: user-service
            dockerfile: services/user-service/Dockerfile
            image_tag: ticketing-user-service
          - name: company-service
            dockerfile: services/company-service/Dockerfile
            image_tag: ticketing-company-service
          - name: ticketing-service
            dockerfile: services/ticketing-service/Dockerfile
            image_tag: ticketing-ticketing-service
          - name: qr-service
            dockerfile: services/qr-service/Dockerfile
            image_tag: ticketing-qr-service
          - name: payment-service
            dockerfile: services/payment-service/Dockerfile
            image_tag: ticketing-payment-service
          - name: ai-service
            dockerfile: services/ai-service/Dockerfile
            image_tag: ticketing-ai-service
          - name: super-admin-service
            dockerfile: services/super-admin-service/Dockerfile
            image_tag: ticketing-super-admin-service

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set Lowercase Repository Owner
        id: slug
        run: echo "IMAGE_OWNER=${GITHUB_REPOSITORY,,}" 
        env:
          GITHUB_REPOSITORY: ${{ github.repository }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ matrix.service.dockerfile }}
          push: ${{ env.DRY_RUN != 'true' }}
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_REPO }}/${{ matrix.service.image_tag }}:${{ github.sha }},${{ env.REGISTRY }}/${{ env.IMAGE_REPO }}/${{ matrix.service.image_tag }}:latest

  deploy_via_ssh:
    runs-on: ubuntu-latest
    needs: build_and_push
    environment: staging
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install SSH Key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          known_hosts: 'placeholder-to-avoid-warning'
          
      - name: Run Deployment on EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 3.12.248.83
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /home/ubuntu/ticketing-system
            git pull origin ${{ github.ref_name }}
            echo ${{ secrets.PAT_GHCR }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            docker compose pull
            docker compose up -d --force-recreate
