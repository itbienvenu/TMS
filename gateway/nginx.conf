
worker_processes 1;

events { worker_connections 1024; }

http {
    sendfile on;

    upstream auth_service {
        server auth-service:8001;
    }

    upstream user_service {
        server user-service:8002;
    }
    
    upstream company_service {
        server company-service:8003;
    }

    upstream ticketing_service {
        server ticketing-service:8004;
    }
    
    upstream qr_service {
        server qr-service:8005;
    }
    
    upstream payment_service {
        server payment-service:8006;
    }

    upstream super_admin_service {
        server super-admin-service:8007;
    }

    upstream ai_service {
        server ai-service:8008;
    }

    upstream tracking_service {
        server tracking-service:8009;
    }

    upstream frontend_service {
        server frontend:5173;
    }

    upstream super_admin_dashboard_service {
        server super-admin-dashboard:5173;
    }

    server {
        listen 8000;

        # Health Check
        location /api/health {
            return 200 '{"status": "Gateway Active"}';
            add_header Content-Type application/json;
        }

        # Frontend
        location / {
            proxy_pass http://frontend_service;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
        }

        # Super Admin Dashboard
        location /super-admin/ {
            proxy_pass http://super_admin_dashboard_service;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
        }

        # Auth Service
        location /api/v1/auth/ {
            proxy_pass http://auth_service/api/v1/auth/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Host $server_name;
        }

        # Legacy Login Route Mapping
        location /api/v1/company-login/ {
            proxy_pass http://auth_service/api/v1/auth/company-login/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Host $server_name;
        }

        # Company Service
        location /api/v1/companies/ {
            proxy_pass http://company_service/api/v1/companies/;
        }

        location /api/v1/routes/ {
            proxy_pass http://company_service/api/v1/routes/;
        }

        location /api/v1/buses/ {
            proxy_pass http://company_service/api/v1/buses/;
        }

        location /api/v1/stations/ {
            proxy_pass http://company_service/api/v1/stations/;
        }

        location /api/v1/drivers/ {
            proxy_pass http://company_service/api/v1/drivers/;
        }
        
        location /api/v1/driver-api/ {
            proxy_pass http://company_service/api/v1/driver-api/;
        }

        location /api/v1/schedules/ {
            proxy_pass http://company_service/api/v1/schedules/;
        }

        location /api/v1/route_segments/ {
            proxy_pass http://company_service/api/v1/route_segments/;
        }
        
        location /api/v1/search/ {
            proxy_pass http://company_service/api/v1/search/;
        }

        location /api/v1/roles/ {
            proxy_pass http://company_service/api/v1/roles/;
        }

        location /api/v1/perm/ {
            proxy_pass http://company_service/api/v1/perm/;
        }

        # User Service
        location /api/v1/users/ {
            proxy_pass http://user_service/api/v1/users/;
        }
        
        # Ticketing Service
        location /api/v1/tickets/ {
            proxy_pass http://ticketing_service/api/v1/tickets/;
        }
        
        # QR Service
        location /api/v1/qr/ {
            proxy_pass http://qr_service/api/v1/qr/;
        }
        
        # Payment Service
        location /api/v1/payments/ {
            proxy_pass http://payment_service/api/v1/payments/;
        }

        # Super Admin Service
        location /api/v1/super-admin/ {
            proxy_pass http://super_admin_service/api/v1/super-admin/;
        }

        # AI Service
        location /api/v1/chat/ {
            if ($request_method = 'OPTIONS') {
                    add_header 'Access-Control-Allow-Origin' '*';
                    add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
                    add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization';
                    add_header 'Access-Control-Max-Age' 1728000;
                    add_header 'Content-Type' 'text/plain; charset=utf-8';
                    add_header 'Content-Length' 0;
                    return 204;
            }
            # Headers are added by the upstream service (FastAPI)
            
            proxy_pass http://ai_service/api/v1/chat/;
        }

        # Tracking Service
        location /api/v1/tracking/ {
            proxy_pass http://tracking_service/api/v1/tracking/;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
    }
}
